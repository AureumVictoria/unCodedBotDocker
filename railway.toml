# UnCoded Trading Bot - Finale Railway Konfiguration
[build]
builder = "NIXPACKS"

# Service 1: PostgreSQL Datenbank
# Wir nennen den Service hier "trading-postgres", um Klarheit zu schaffen
[[services]]
name = "trading-postgres"
image = "postgres:16-alpine"
restartPolicy = "on-failure"
  [services.trading-postgres.variables]
  POSTGRES_DB = "railway" # Name der DB laut deinen Variablen
  POSTGRES_USER = "postgres"
  POSTGRES_PASSWORD = "${RAILWAY_PASSWORD}"
  [[services.trading-postgres.volumes]]
  mount = "/var/lib/postgresql/data"
  name = "postgres-data"

# Service 2: Der Trading-Bot
[[services]]
name = "trading-bot"
image = "./"
restartPolicy = "on-failure"
  [services.trading-bot.variables]
  # Korrekte Verknüpfung mit dem Namen "trading-postgres"
  POSTGRES_HOST = "${{trading-postgres.PGHOST}}"
  POSTGRES_PORT = "${{trading-postgres.PGPORT}}"
  POSTGRES_DB = "${{trading-postgres.PGDATABASE}}"
  POSTGRES_USER = "${{trading-postgres.PGUSER}}"
  POSTGRES_PASSWORD = "${{trading-postgres.PGPASSWORD}}"
  DATABASE_URL = "${{trading-postgres.DATABASE_URL}}"
  DOCKER_ENV = "true"
  # Secrets werden aus dem Dashboard geladen
  API_KEY = "${{API_KEY}}" 
  API_SECRET = "${{API_SECRET}}"

# Service 3: Der Telegram-Bot
[[services]]
name = "telegram-bot"
image = "./"
startCommand = "node tgbot.js"
restartPolicy = "on-failure"
  [services.telegram-bot.variables]
  # KORRIGIERT: Auch hier die korrekte Verknüpfung mit dem Namen "trading-postgres"
  POSTGRES_HOST = "${{trading-postgres.PGHOST}}"
  POSTGRES_PORT = "${{trading-postgres.PGPORT}}"
  POSTGRES_DB = "${{trading-postgres.PGDATABASE}}"
  POSTGRES_USER = "${{trading-postgres.PGUSER}}"
  POSTGRES_PASSWORD = "${{trading-postgres.PGPASSWORD}}"
  DATABASE_URL = "${{trading-postgres.DATABASE_URL}}"
  # Secrets werden aus dem Dashboard geladen
  TELEGRAM_BOT_TOKEN = "${{TELEGRAM_BOT_TOKEN}}"
  TELEGRAM_GROUP_ID = "${{TELEGRAM_GROUP_ID}}"
  TELEGRAM_OWNER_ID = "${{TELEGRAM_OWNER_ID}}"